<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>DisasterScout Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
        }

        #app {
            display: flex;
            height: 100%;
        }

        #leftPane {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        #chatPane {
            flex: 1;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }

        #controls {
            padding: 8px 12px;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        #controls select,
        #controls input,
        #controls button {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background: #111827;
            color: #e5e7eb;
        }

        #controls button {
            cursor: pointer;
            border-color: #2563eb;
        }

        #status {
            font-size: 12px;
            opacity: 0.8;
        }

        #map {
            width: 100%;
            flex: 1;
        }

        .legend {
            background: white;
            padding: 6px 8px;
            font-size: 12px;
            line-height: 18px;
            color: #111827;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .legend div {
            margin-bottom: 4px;
        }

        /* Chat styles */

        #chatHeader {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 14px;
            background: #f3f4f6;
        }

        #chatWindow {
            flex: 1;
            padding: 10px 12px;
            overflow-y: auto;
            font-size: 14px;
        }

        .chat-message {
            margin-bottom: 10px;
        }

        .chat-sender {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-text {
            white-space: pre-wrap;
        }

        #chatForm {
            display: flex;
            padding: 8px 10px;
            border-top: 1px solid #e5e7eb;
            background: #ffffff;
            gap: 8px;
        }

        #chatInput {
            flex: 1;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        #chatSend {
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #2563eb;
            background: #2563eb;
            color: white;
            cursor: pointer;
        }

        #chatHint {
            padding: 4px 10px 10px 10px;
            font-size: 12px;
            color: #6b7280;
        }

        .open-map-btn {
            margin-top: 6px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #2563eb;
            background: #eff6ff;
            color: #1d4ed8;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="leftPane">
            <div id="controls">
                <span><strong>DisasterScout</strong></span>

                <label>
                    Region:
                    <select id="regionSelect">
                        <option value="Brooklyn, NY">Brooklyn, NY (flood)</option>
                        <option value="Bay Ridge, Brooklyn, NY">
                            Bay Ridge, Brooklyn (flood)
                        </option>
                        <option value="Qui Nhon, Vietnam">Qui Nhon, Vietnam (flood)</option>
                        <option value="Binh Dinh Province, Vietnam">
                            Binh Dinh Province, Vietnam (flood)
                        </option>
                    </select>
                </label>

                <button id="loadRegionBtn">Load region</button>

                <span>|</span>

                <label>
                    Near me radius (km):
                    <input id="radiusInput" type="number" value="20" min="1" max="200" step="1" />
                </label>
                <button id="nearMeBtn">Use my location</button>

                <span id="status"></span>
            </div>

            <div id="map"></div>
        </div>

        <div id="chatPane">
            <div id="chatHeader">DisasterScout assistant</div>
            <div id="chatWindow"></div>
            <form id="chatForm">
                <input id="chatInput" type="text" placeholder="Type: Flood in Brooklyn, NY" autocomplete="off" />
                <button id="chatSend" type="submit">Send</button>
            </form>
            <div id="chatHint">
                Examples: "Flood in Brooklyn, NY", "Flood in Qui Nhon, Vietnam".
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Base map setup ---
        const map = L.map("map").setView([40.6526, -73.9497], 11); // Brooklyn default

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // Layer group so we can clear markers when switching region / near-me
        const incidentLayer = L.layerGroup().addTo(map);

        function jitterCoord(value, magnitude) {
            // small random offset so overlapping markers separate visually
            return value + (Math.random() - 0.5) * magnitude;
        }

        function categoryColor(category) {
            switch (category) {
                case "SOS":
                    return "red";
                case "SHELTER":
                    return "green";
                case "INFO":
                default:
                    return "blue";
            }
        }

        function renderIncidents(featureCollection, options) {
            const opts = options || {};
            const fitBounds = opts.fitBounds !== false;

            incidentLayer.clearLayers();

            const features = featureCollection.features || [];
            const statusEl = document.getElementById("status");
            if (features.length === 0) {
                statusEl.textContent = "No incidents found.";
                return;
            }

            const geoLayer = L.geoJSON(featureCollection, {
                pointToLayer: function (feature, latlng) {
                    const cat =
                        (feature.properties && feature.properties.category) || "INFO";
                    const color = categoryColor(cat);

                    // Jitter slightly so stacked points are visible
                    const jittered = L.latLng(
                        jitterCoord(latlng.lat, 0.001),
                        jitterCoord(latlng.lng, 0.001)
                    );

                    return L.circleMarker(jittered, {
                        radius: 8,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8,
                    });
                },
                onEachFeature: function (feature, layer) {
                    const p = feature.properties || {};
                    const linksHtml = (p.source_links || [])
                        .map(function (u) {
                            return '<a href="' + u + '" target="_blank">source</a>';
                        })
                        .join(" | ");

                    let distance = "";
                    if (typeof p.distance_m === "number") {
                        distance =
                            "<small>Distance: " +
                            (p.distance_m / 1000).toFixed(1) +
                            " km</small><br/>";
                    }

                    const html =
                        "<strong>" +
                        (p.category || "INFO") +
                        "</strong><br/>" +
                        (p.description || "") +
                        "<br/>" +
                        "<small>" +
                        (p.region || "") +
                        "</small><br/>" +
                        "<small>Reports: " +
                        (p.report_count || 1) +
                        "</small><br/>" +
                        distance +
                        linksHtml;

                    layer.bindPopup(html);
                },
            });

            geoLayer.addTo(incidentLayer);

            if (fitBounds) {
                try {
                    map.fitBounds(geoLayer.getBounds(), { padding: [40, 40] });
                } catch (e) {
                    // ignore
                }
            }

            statusEl.textContent = "Loaded " + features.length + " incident(s).";
        }

        // --- API helpers ---

        async function loadRegion(region) {
            const statusEl = document.getElementById("status");
            statusEl.textContent = "Loading " + region + "...";

            const url = "/api/incidents?region=" + encodeURIComponent(region);
            const res = await fetch(url);
            if (!res.ok) {
                statusEl.textContent = "Error: " + res.status;
                return;
            }
            const data = await res.json();
            renderIncidents(data, { fitBounds: true });
        }

        async function loadNearMe(lat, lon, radiusKm) {
            const statusEl = document.getElementById("status");
            statusEl.textContent =
                "Loading incidents within " + radiusKm + " km of you...";

            const params = new URLSearchParams({
                lat: String(lat),
                lon: String(lon),
                radius_km: String(radiusKm),
            });

            const url = "/api/incidents_near?" + params.toString();
            const res = await fetch(url);
            if (!res.ok) {
                statusEl.textContent = "Error: " + res.status;
                return;
            }
            const data = await res.json();
            renderIncidents(data, { fitBounds: true });
        }

        // --- UI wiring for map controls ---

        const regionSelect = document.getElementById("regionSelect");
        const loadRegionBtn = document.getElementById("loadRegionBtn");
        const nearMeBtn = document.getElementById("nearMeBtn");
        const radiusInput = document.getElementById("radiusInput");

        loadRegionBtn.addEventListener("click", function () {
            const region = regionSelect.value;
            loadRegion(region);
        });

        nearMeBtn.addEventListener("click", function () {
            const statusEl = document.getElementById("status");
            if (!navigator.geolocation) {
                statusEl.textContent = "Geolocation is not supported in this browser.";
                return;
            }
            const radius = parseFloat(radiusInput.value) || 20;

            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    loadNearMe(lat, lon, radius);
                },
                function (err) {
                    console.error(err);
                    statusEl.textContent =
                        "Failed to get your location (permission denied?).";
                }
            );
        });

        // Initial load: check ?region=... or fall back to select
        (function () {
            const params = new URLSearchParams(window.location.search);
            const regionFromUrl = params.get("region");
            const initialRegion = regionFromUrl || regionSelect.value;
            if (regionFromUrl) {
                // do not worry if it is not in the dropdown
                loadRegion(regionFromUrl);
            } else {
                loadRegion(initialRegion);
            }
        })();

        // --- Legend ---
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML =
                '<div><span style="display:inline-block;width:12px;height:12px;background:red;border-radius:50%;margin-right:4px;"></span> SOS</div>' +
                '<div><span style="display:inline-block;width:12px;height:12px;background:green;border-radius:50%;margin-right:4px;"></span> Shelter</div>' +
                '<div><span style="display:inline-block;width:12px;height:12px;background:blue;border-radius:50%;margin-right:4px;"></span> Info</div>';
            return div;
        };
        legend.addTo(map);

        // --- Chat logic ---

        const chatWindow = document.getElementById("chatWindow");
        const chatForm = document.getElementById("chatForm");
        const chatInput = document.getElementById("chatInput");

        function addChatMessage(sender, text, extraHtml) {
            const msg = document.createElement("div");
            msg.className = "chat-message";

            const senderEl = document.createElement("div");
            senderEl.className = "chat-sender";
            senderEl.textContent = sender;

            const textEl = document.createElement("div");
            textEl.className = "chat-text";
            textEl.textContent = text || "";

            msg.appendChild(senderEl);
            msg.appendChild(textEl);

            if (extraHtml) {
                const extraWrapper = document.createElement("div");
                extraWrapper.innerHTML = extraHtml;
                msg.appendChild(extraWrapper);
            }

            chatWindow.appendChild(msg);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const message = (chatInput.value || "").trim();
            if (!message) {
                return;
            }

            addChatMessage("You", message, null);
            chatInput.value = "";

            fetch("/api/chat_query", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message: message }),
            })
                .then(function (res) {
                    if (!res.ok) {
                        throw new Error("HTTP " + res.status);
                    }
                    return res.json();
                })
                .then(function (data) {
                    if (!data.ok) {
                        addChatMessage(
                            "Assistant",
                            data.error || "Query failed.",
                            null
                        );
                        return;
                    }

                    const summary = data.summary || "No summary available.";
                    const region = data.region || "";

                    let extraHtml = "";
                    if (region) {
                        // IMPORTANT: keep region locally and do not navigate away.
                        // The click handler will call loadRegion(region).
                        extraHtml =
                            '<button class="open-map-btn" ' +
                            'data-region="' +
                            region +
                            '">Open map for ' +
                            region +
                            "</button>";
                    }

                    addChatMessage("Assistant", summary, extraHtml);
                })
                .catch(function (err) {
                    console.error(err);
                    addChatMessage(
                        "Assistant",
                        "Sorry, something went wrong handling that request.",
                        null
                    );
                });
        });

        chatWindow.addEventListener("click", function (e) {
            const target = e.target;
            if (!target) {
                return;
            }
            if (target.classList.contains("open-map-btn")) {
                const region = target.getAttribute("data-region");
                if (region) {
                    // Update dropdown if possible
                    const options = Array.from(regionSelect.options);
                    const match = options.find((opt) => opt.value === region);
                    if (match) {
                        regionSelect.value = region;
                    }
                    // Recenter map to that region, but DO NOT reload page
                    loadRegion(region);
                }
            }
        });
    </script>
</body>

</html>