<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>DisasterScout â€“ Brooklyn Flood Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .legend div {
            margin-bottom: 4px;
        }

        .legend span.dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const API_BASE = window.location.origin;

        const map = L.map("map").setView([40.68, -73.95], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        function getColor(category, status) {
            category = (category || "").toUpperCase();
            status = (status || "").toUpperCase();

            if (category === "SOS") {
                return "red";
            }
            if (category === "SHELTER" && status === "VERIFIED") {
                return "green";
            }
            if (category === "SHELTER") {
                return "orange";
            }
            // INFO / other
            return "blue";
        }

        function addIncidentsToMap(featureCollection) {
            featureCollection.features.forEach((f) => {
                if (!f.geometry || f.geometry.type !== "Point") return;
                const coords = f.geometry.coordinates || [];
                if (coords.length !== 2) return;

                const lon = coords[0];
                const lat = coords[1];

                // Leaflet expects [lat, lon]
                const pos = [lat, lon];

                const props = f.properties || {};
                const color = getColor(props.category, props.status);

                const marker = L.circleMarker(pos, {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8,
                });

                const desc = props.description || "(no description)";
                const cat = props.category || "UNKNOWN";
                const status = props.status || "UNVERIFIED";
                const region = props.region || "";
                const topic = props.topic || "";

                let popupHtml = `<strong>${desc}</strong><br/>`;
                popupHtml += `<b>Category:</b> ${cat}<br/>`;
                popupHtml += `<b>Status:</b> ${status}<br/>`;
                if (topic) popupHtml += `<b>Topic:</b> ${topic}<br/>`;
                if (region) popupHtml += `<b>Region:</b> ${region}<br/>`;

                const links = props.source_links || [];
                if (links.length > 0) {
                    popupHtml += "<b>Sources:</b><br/>";
                    links.slice(0, 3).forEach((url) => {
                        popupHtml += `<a href="${url}" target="_blank">Source</a><br/>`;
                    });
                }

                marker.bindPopup(popupHtml);
                marker.addTo(map);
            });
        }

        async function loadIncidents() {
            const region = encodeURIComponent("Brooklyn, NY");
            const url = `${API_BASE}/api/incidents?region=${region}`;

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    console.error("Failed to fetch incidents:", res.status);
                    return;
                }
                const data = await res.json();
                addIncidentsToMap(data);
            } catch (err) {
                console.error("Error fetching incidents:", err);
            }
        }

        // Legend
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = `
        <div><span class="dot" style="background:red;"></span>SOS</div>
        <div><span class="dot" style="background:green;"></span>Verified shelter</div>
        <div><span class="dot" style="background:orange;"></span>Unverified shelter</div>
        <div><span class="dot" style="background:blue;"></span>Info / other</div>
      `;
            return div;
        };
        legend.addTo(map);

        loadIncidents();
    </script>
</body>

</html>